js_promise
Js Promise
js 


<h3 id="toc_0">异步编程</h3>

<p>同步行为和异步行为的对立统一是计算机科学的一个基本概念。特别是在 JavaScript 这种<strong>单线程事件循环模型中</strong>，同步操作和异步操作更是代码所要依赖的核心机制。异步行为是为了优化因计算量大而时间长的操作。如果在等待其他操作完成的同时，即使运行其他指令，系统也能保持稳定。</p>

<p>重要的是，异步操作并不一定计算量大或要等很长时间。只要你不行为等待某个异步操作而阻塞线程执行，那么任何时候都可以使用。</p>

<h3 id="toc_1">同步与异步</h3>

<p><strong>同步行为</strong>对应内存中顺序执行的处理器指令。每条指令都会严格按照它们出现的顺序执行，而每条指令执行后也能立即获得存储在系统本地（如寄存器或系统内存）的信息。这样的执行流程容易分析程序在执行任意位置时的状态的（比如变量的值）。</p>

<p>同步操作的例子可以是执行一次简单的数学计算：</p>

<pre><code class="javascript">let x = 3;
x = x + 4;
</code></pre>

<p>这两行 JavaScript 代码对应的低级指令（从 JavaScript 到 x86）不难想象。首先，操作系统会在栈内存上分配一个存储浮点数值的空间，然后针对这个值做一次数学计算，再把计算结果写回之前分配的内存中。所有这些指令都是在单个线程中按顺序执行的。在低级指令的层面。有充足的工具可以确定系统状态。</p>

<p><strong>异步行为</strong>类似于系统中断，即当前进程外部地实体可以触发代码执行，异步操作经常是必须要的，因为强制进程等待一个长时间的操作通常是不可行的（同步操作则必须等）。如果代码要访问一些高延迟的资源，比如向远程服务器发送请求并等待响应，那么就会出现长时间的等待。</p>

<p>异步操作的例子可以是在定时回调中执行一次简单的数学计算：</p>

<pre><code class="javascript">let x = 3;
setTimeout(() =&gt; x = x + 4, 1000);
</code></pre>

<p>这段程序最终和同步代码执行的任务一样，但这一次执行线程不知道 x 值何时会改变，因为这取决于回调何时从消息队列出列并执行。</p>

<p>异步操作不同意推断。虽然此例对应的低级代码最终和前面的例子没什么区别，但第二个指令是由系统计时器触发的，这回生成一个入队执行的中断，何时会触发这个中断，这对 JavaScript 运行时是一个黑盒，因此实际上无法预知（尽管可以保证这发生在当前线程的同步代码执行之后，否则回调都没机会出列被执行）。无论如何，在排定回调以后基本没办法知道系统状态何时变化。</p>

<h3 id="toc_2">以往的异步编程模式</h3>

<h3 id="toc_3">Promise</h3>

<p>ECMAScript6 新增的引用类型 promise，可以通过 new 操作符来实例化。创建新 promise 时需要传入执行器（executor）函数作为参数。</p>

<pre><code class="javascript">let p = new promise(() =&gt; ());
setTimeout(console.log, 0, p);  // Promise &lt;pending&gt;
</code></pre>

<p>如果不提供执行器函数，就会抛出 <i>SyntaxError</i></p>

<h4 id="toc_4">promise 状态</h4>

<p>promise 是一个由状态的对象，可能处于以下 3 中状态之一：</p>

<ul>
<li>pending（待定）</li>
<li>fulfilled（兑现，有时也称”解决“，resolved）</li>
<li>reject（拒绝）</li>
</ul>

<p>pending 是 promise 的最初始状态。在特定状态下，promise 可以<strong>落定</strong>（settled）为代表成功的 fulfilled 状态，或者代表失败的 reject 状态。无论落定为哪种状态都是<strong>不可逆</strong>的。</p>

<p>promise 状态是<strong>私有</strong>的，不能直接通过 JavaScript 检测到。这主要是为了避免根据读取到的状态，以同步方式处理 promise 对象。另外，状态也不能被外部代码修改。这与不能读取状态原因一致。promise 故意将异步行为封装起来，从而隔离外部的同步代码。</p>

<h4 id="toc_5">解决值、拒绝理由以及 promise 用例</h4>
