redis_memory
Redis 内存优化
redis 


<p>redis所有数据都存在内存中</p>

<h3 id="toc_0">redisObject 对象</h3>

<p>Redis 存储的所有值都在内部定义为 redisObject 结构体。</p>

<pre><code>type: 4                             // 对象类型
encoding: 4                         // 内部编码类型
lruREDIS_LRU_BITS                   // LRU计时时钟
int refcount                        // 引用计数器
void *ptr                           // 数据指针
</code></pre>

<p>Redis 存储的数据都使用 redisObject 来封装，包括 string、hash、list、set、zset 在内的所有数据类型。理解 redisObject 对内存优化十分有帮助：</p>

<ul>
<li><p>type 字段：表示当前对象使用的数据类型</p></li>

<li><p>encoding 字段：表示 Redis 内部编码类型</p></li>

<li><p>lru 字段：记录对象最后一次被访问的时间，当配置了maxmemory 和 maxmemory-policy=volatile-lru 或者 allkeys-lru 时，用于辅助 LRU 算法删除键数据。可以使用 object idletime {key} 命令在不更新 lru 字段情况下查看当前键的空闲时间</p></li>
</ul>

<p><strong>Tip</strong>：可以使用 scan + object idletime 命令批量查询哪些键长时间未被访问。找出长时间不访问的键进行清理，可降低内存占用</p>

<ul>
<li><p>refcount 字段：记录当前对象被引用的次数，用于通过引用次数回收内存，当 refcount = 0 时，可以安全回收当前对象空间。使用 object refcount {key} 获取当前对象引用。当对象为整数且范围在[0-9999] 时，Redis 可以使用共享对象的方式来节约内存。具体见共享对象池部分。</p></li>

<li><p>*ptr 字段：与对象的数据内容相关，如果是整数，直接存储数据；否则表示指向数据的指针。Redis 在 3.0 之后对值对象是字符串且长度&lt;=39 字节的数据，内部编码为 embstr 类型，字符串 sds 和 redisObject 一起分配，从而只要一次内存操作即可</p></li>
</ul>

<p>tip：高并发写入场景中，在条件允许的情况下，建议字符串长度控制在 39 字节以内，减少创建 redisObject 内存分配次数，从而提高性能</p>

<h3 id="toc_1">缩减键值对象</h3>

<p>降低 Redis 内存使用<strong>最直接的方式就是缩减键（key）和值（value）的长度</strong></p>

<ul>
<li><p>key 长度：如在设计键时，在完整描述业务情况下，键值越短越好。如 user:{uid}:friends:notify:{fid} 可简化为 u:{uid}:fs:nt:{fid}</p></li>

<li><p>value 长度：值对象缩减比较复杂，常见需求是把业务对象序列化成二进制数组放入 Redis。首先应该在业务上精简业务对象，去掉不必要的属性避免存储无效数据。其次在序列化工具选择上，应该选择更高效的序列化工具来降低字节数组大小。以 Java 为例，内置的序列化方式无论从速度还是压缩比都不尽人意。这时可以选择更高效的序列化工具，如：protostuff、kryo 等</p></li>
</ul>

<p>值对象除了存储二进制数据之外，通常还会使用通用格式存储数据比如：json、xml等作为字符串存储在 Redis 中。这种方式的优点是方便调试和跨语言，但是同样的数据相比字节数组所需的空间更大，在内存紧张的情况下，可以使用通用压缩算法压缩 json、xml 后再存入 redis，从而降低内存占用，例如 GZIP 压缩后的 json 可降低 60% 的空间。</p>

<p><strong>Tip</strong>：当频繁压缩解压 json 等文本数据时，开发人员要考虑压缩速度和计算开销成本，这里推荐使用 Google 的 Snappy 压缩工具，在特定的压缩情况下效率远远高于 GZIP 等传统压缩工具、且支持所有主流语言环境。</p>

<h3 id="toc_2">共享对象池</h3>
