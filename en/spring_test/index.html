spring_test
Spring Test
spring 


<p>单元测试的必要性</p>

<ul>
<li>预防 Bug</li>
<li>快速定位 Bug</li>
<li>提高代码质量，减少耦合</li>
<li>减少调试时间</li>
<li>减少重构的风险</li>
</ul>

<h3 id="toc_0">Spring Boot 的测试库</h3>

<p>Spring Boot 提供了 spring-boot-starter-test 启动器。通过它，能引入一些有用的测试库，如下所示</p>

<ul>
<li>Spring Test&amp;Spring Boot Test：Spring Boot 提供的应用程序功能集成化测试支持</li>
<li>Junit：Java 应用程序单元测试标准类库</li>
<li>AssertJ：轻量级的断言类库</li>
<li>Hamcrest：对象匹配器类库</li>
<li>Mockito：Java Mork 测试框架</li>
<li>JsonPath：JSON 操作类库</li>
<li>JSONassert：用于 JSON 的断言库</li>
</ul>

<h4 id="toc_1">1. 了解回归测试框架 JUnit</h4>

<p>JUnit 测试是白盒测试。要使用 JUnit，则只需要继承 TestCase 类。</p>

<p>JUnit 提供以下注解</p>

<ul>
<li><code>@BeforeClass</code> ：在所有测试单元前执行一次，一般用来初始化整体的代码</li>

<li><p><code>@AfterClass</code> ：在所有测试单元后执行一次，一般用来销毁和释放资源</p></li>

<li><p><code>@Before</code> ：在每个测试单元前执行，一般用来初始化方法</p></li>

<li><p><code>@After</code> ：在每个测试单元前执行，一般用来回滚测试数据</p></li>

<li><p><code>@Test</code> ：编写测试用例</p></li>

<li><p><code>@Test(timeout=1000)</code> ：对测试单元进行限时。“1000” 表示超过 1s 则超时，测试失败</p></li>

<li><p><code>@Test(expected=Exception.class)</code> ：指定测试单元期望得到的异常类。如果执行完成后没有抛出指定的异常，则测试失败</p></li>

<li><p><code>@Ignore</code> ：执行测试时将忽略掉此方法。如果用于修饰类，则忽略整个类</p></li>

<li><p><code>@RunWith</code> ：在 JUnit 中有很多 Runner，它们负责调用测试代码。每个 Runner 都有特殊功能，应根据需要选择不同的 Runner 来运行测试代码</p></li>
</ul>

<h4 id="toc_2">2. 了解 assertThat</h4>

<p>Unit 4.4 结合 Hamcrest 提供了一个新的断言语法——assertThat。使用 assertThat 的一个断言语句结合 Hamcrest 提供的匹配符，就可以表达全部的测试思想。</p>

<p>1）assertThat 的基本语法如下。</p>

<pre><code class="java">assertThat([value], [matcher statement]);
</code></pre>

<ul>
<li>value：要测试的变量值</li>
<li>master statement：如果 value 值与 master statement 所表达的期望值相符，则测试成功，否则失败。就是两个值比较</li>
</ul>

<p>2）一般匹配符</p>

<ul>
<li><code>assertThat(testNumber, allOf(greaterThan(5), lessThan(8)));</code> ：allOf 表示，所有条件必须都成立，测试才能通过。</li>
<li><code>assertThat(testNumber, anyOf(greaterThan(5), lessThan(8)));</code> ：allOf 表示，所有条件只要有一个成立，测试才能通过。</li>
<li><code>assertThat(testNumber, anythong());</code> ：anything 表示，无论什么条件，结果永远为 true。</li>
</ul>

<p>3）字符串相关匹配符</p>

<p>4）数值相关匹配符</p>

<p>5）collection 相关匹配符</p>

<h4 id="toc_3">3. 了解 Mockito</h4>

<p>Mockito 是 Github 上使用最广泛的 Mocking 框架。它提供简洁的 API 用来测试。与 JUnit 结合使用，Mockito 框架可以创建和配置 Mock 对象。</p>

<h4 id="toc_4">4. 了解 JSONPath</h4>

<p>JSONPath 是 xPath 在 JSON 中的应用，它的数据结构通常不一定有根元素，它用一个抽象的名字 “$” 来表示最外层对象，而且允许使用通配符 “*” 表示所有的子元素和数组索引。</p>

<p>JSONPath 表达式可以使用 “.” 符号解析 JSON，如下代码</p>

<pre><code class="java">$.person.card[0].num
</code></pre>

<p>或使用 “[]” 符号</p>

<pre><code class="java">$['persion']['card'][0]['num']
</code></pre>

<h4 id="toc_5">5. 测试的回滚</h4>

<p>在单元测试中可能会产生垃圾数据，可以开启事务功能进行回滚——在方法或类头部添加注解 @Transaction 即可</p>

<pre><code class="java">@RunWith(SpringRunner.calss)
@SpringBootTest
@Transactional
public class CardRepositoryTest {
    @Autowired
    private CardReponsitory cardReponsitory;
    
    @Test
    public void testRollBank() {
        // 查询操作
        Card card = new Card();
        card.setNum();
        cardReponsitory.save(card);
    }
}
</code></pre>

<p>在类上添加了注解 @Transactional，测试完成后就会回滚，不会产生垃圾数据。如果关闭回滚，则只需加上注解 @Rollback(false) 即可</p>

<p>Tip：如果使用数据库是 MySQL，有时注解 @Transactional 不会回滚，多数情况下是因为默认引擎不是 InnoDB.</p>

<h3 id="toc_6">快速创建测试单元</h3>

<h4 id="toc_7">添加依赖</h4>

<pre><code class="xml">
</code></pre>

<p>在 “src/test/java” 目录下新建一个测试类</p>

<pre><code class="java">@RunWith(SpringRunner.class)
public class test {
    @Test
    public void contextLoads() {
        // 测试代码
    }
}
</code></pre>
