<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <link rel="stylesheet" href="/css/style.css">
    <title>gniqizeuy blog</title>
</head>
<body>
<header id="header">
    <h1><a href="/">gniqizeuy blog</a></h1>
    <nav>
        <ul>
            <li><a href="/tags">tags</a></li>
            <li><a href="/sites">sites</a></li>
            <li><a href="https://github.com/spaghettiwews/hugonews">github</a></li>
        </ul>
    </nav>
</header>
<main id="main">
    <article class="single">
        
        <h4 id="error-接口">error 接口</h4>
<p>go中 error 只是一个接口类型，不包含返回错误消息的方法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">type</span> <span style="color:#458;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">interface</span> {
    <span style="color:#900;font-weight:bold">Error</span>() <span style="color:#458;font-weight:bold">string</span>
}
</code></pre></div><h4 id="errors-package">errors package</h4>
<p>errors 包中 errors.go 源码如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">package</span> errors

<span style="color:#998;font-style:italic">// New returns an error that formats as the given text.
</span><span style="color:#998;font-style:italic">// Each call to New returns a distinct error value even if the text is identical.
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">New</span>(text <span style="color:#458;font-weight:bold">string</span>) <span style="color:#458;font-weight:bold">error</span> {
	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">&amp;</span>errorString{text}
}

<span style="color:#998;font-style:italic">// errorString is a trivial implementation of error.
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">type</span> errorString <span style="color:#000;font-weight:bold">struct</span> {
	s <span style="color:#458;font-weight:bold">string</span>
}

<span style="color:#000;font-weight:bold">func</span> (e <span style="color:#000;font-weight:bold">*</span>errorString) <span style="color:#900;font-weight:bold">Error</span>() <span style="color:#458;font-weight:bold">string</span> {
	<span style="color:#000;font-weight:bold">return</span> e.s
}
</code></pre></div><p>底层的 <code>errorString</code> 类型是一个结构体，并没有直接使用字符串，是为了避免将来可能的布局变更。
满足 error 接口的是 <code>*errorString</code> 指针，主要是为了让 New 分配的 error 实例互不相等。
像 <code>io.EOF</code> 这样的重要错误，不可与仅仅包含同样错误消息的</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">fmt.<span style="color:#900;font-weight:bold">Println</span>(errors.<span style="color:#900;font-weight:bold">New</span>(<span style="color:#d14">&#34;EOF&#34;</span>) <span style="color:#000;font-weight:bold">==</span> errors.<span style="color:#900;font-weight:bold">New</span>(<span style="color:#d14">&#34;EOF&#34;</span>)) <span style="color:#998;font-style:italic">// false
</span></code></pre></div><p><code>fmt.Errorf</code> 函数提供了字符串格式化功能</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">package</span> fmt

<span style="color:#000;font-weight:bold">import</span> <span style="color:#d14">&#34;errors&#34;</span>

<span style="color:#998;font-style:italic">// Errorf formats according to a format specifier and returns the string as a
</span><span style="color:#998;font-style:italic">// value that satisfies error.
</span><span style="color:#998;font-style:italic">//
</span><span style="color:#998;font-style:italic">// If the format specifier includes a %w verb with an error operand,
</span><span style="color:#998;font-style:italic">// the returned error will implement an Unwrap method returning the operand. It is
</span><span style="color:#998;font-style:italic">// invalid to include more than one %w verb or to supply it with an operand
</span><span style="color:#998;font-style:italic">// that does not implement the error interface. The %w verb is otherwise
</span><span style="color:#998;font-style:italic">// a synonym for %v.
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Errorf</span>(format <span style="color:#458;font-weight:bold">string</span>, a <span style="color:#000;font-weight:bold">...</span><span style="color:#000;font-weight:bold">interface</span>{}) <span style="color:#458;font-weight:bold">error</span> {
	p <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">newPrinter</span>()
	p.wrapErrs = <span style="color:#000;font-weight:bold">true</span>
	p.<span style="color:#900;font-weight:bold">doPrintf</span>(format, a)
	s <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">string</span>(p.buf)
	<span style="color:#000;font-weight:bold">var</span> err <span style="color:#458;font-weight:bold">error</span>
	<span style="color:#000;font-weight:bold">if</span> p.wrappedErr <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
		err = errors.<span style="color:#900;font-weight:bold">New</span>(s)
	} <span style="color:#000;font-weight:bold">else</span> {
		err = <span style="color:#000;font-weight:bold">&amp;</span>wrapError{s, p.wrappedErr}
	}
	p.<span style="color:#900;font-weight:bold">free</span>()
	<span style="color:#000;font-weight:bold">return</span> err
}

<span style="color:#000;font-weight:bold">type</span> wrapError <span style="color:#000;font-weight:bold">struct</span> {
	msg <span style="color:#458;font-weight:bold">string</span>
	err <span style="color:#458;font-weight:bold">error</span>
}

<span style="color:#000;font-weight:bold">func</span> (e <span style="color:#000;font-weight:bold">*</span>wrapError) <span style="color:#900;font-weight:bold">Error</span>() <span style="color:#458;font-weight:bold">string</span> {
	<span style="color:#000;font-weight:bold">return</span> e.msg
}

<span style="color:#000;font-weight:bold">func</span> (e <span style="color:#000;font-weight:bold">*</span>wrapError) <span style="color:#900;font-weight:bold">Unwrap</span>() <span style="color:#458;font-weight:bold">error</span> {
	<span style="color:#000;font-weight:bold">return</span> e.err
}
</code></pre></div>
        
    </article>
</main>
<footer id="footer">look ma, a footer</footer>
</body>
</html>